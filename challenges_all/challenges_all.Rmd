---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup1, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 1**

1. Plot the counts-per-million versus counts for the second sample.
2. Add a vertical line at 0.5 and a horizontal line at 10.
3. Add the lines again, colouring them blue. HINT: use the `col` parameter.

```{r challenge1, exercise=TRUE}
# Try running this code then edit
plot(myCPM[,1],countdata[,1],ylim=c(0,50),xlim=c(0,3))
abline(v=0.5)
```

```{r, challenge1-solution, exercise.reveal_solution = FALSE}
plot(myCPM[,2],countdata[,2],ylim=c(0,50),xlim=c(0,3))
abline(v=0.5,col="blue")
abline(h=10,col="blue")
```


```{r challenge1-code-check}
grade_this_code()
```
---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup10, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 10**

1. Run `camera` on the second contrast in the contrast matrix.
2. Run `camera` on a different set of MSigDB gene sets, the hallmark datasets, `mouse_H_v5.rdata`.
You will need to load in the hallmark gene sets. Call the object `Mm.H`.

```{r challenge10, exercise=TRUE}
Mm.H <- readRDS(url("http://bioinf.wehi.edu.au/MSigDB/v7.1/Mm.h.all.v7.1.entrez.rds"))
H.ind <- ____
H.camera <- ____
table(H.camera$FDR < ____)
H.camera[1:10,]
```

```{r challenge10-solution, exercise.reveal_solution = FALSE}
Mm.H <- readRDS(url("http://bioinf.wehi.edu.au/MSigDB/v7.1/Mm.h.all.v7.1.entrez.rds"))
H.ind <- ids2indices(Mm.H, rownames(v))
H.camera <- camera(v,index=H.ind,design=design,contrast = cont.matrix[,1],inter.gene.cor=0.05)
table(H.camera$FDR < 0.05)
H.camera[1:10,]
```

```{r challenge10-code-check}
grade_this_code()
```---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup11, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 11**

1. Test whether the MYC signalling pathways tend to be differentially expressed between luminal pregnant vs lactating (the second contrast).

```{r challenge11_1, exercise=TRUE}
myc.rst2 <- ____
myc.rst2[____]
````

```{r challenge11_1-solution, exercise.reveal_solution = FALSE}
myc.rst2 <- roast(v,index=c2.ind[myc],design=design,contrast=cont.matrix[,2],nrot=999)
myc.rst2[1:15,]
```

```{r challenge11_1-code-check}
grade_this_code()
```

2. Look for gene sets containing "WNT" in the name and see whether they tend to be differentially expressed in basal pregnant vs lactating.

```{r challenge11_2, exercise=TRUE}
wnt <- grep(____)
wnt.rst <- ____
wnt.rst[____]
```

```{r challenge11_2-solution, exercise.reveal_solution = FALSE}
wnt <- grep("WNT",names(c2.ind))
wnt.rst <- roast(v,index=c2.ind[wnt],design=design,contrast=cont.matrix[,1],nrot=999)
wnt.rst[1:15,]
```

```{r challenge11_2-code-check}
grade_this_code()
```---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup12, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 12**

1. Produce a barcodeplot for luminal pregnant vs lactating for the gene set DANG_REGULATED_BY_MYC_UP. Does the pattern of enrichment look as strong?

```{r challenge12_1, exercise=TRUE}
barcodeplot(____, main="L.PregVsLac: DANG_REGULATED_BY_MYC_UP")
````

```{r challenge12_1-solution, exercise.reveal_solution = FALSE}
barcodeplot(fit.cont$coeff[,2], index=c2.ind[["DANG_REGULATED_BY_MYC_UP"]], main="L.PregVsLac: DANG_REGULATED_BY_MYC_UP")
```

```{r challenge12_1-code-check}
grade_this_code()
```

2. Produce a barcode plot for the Wnt signalling pathways REACTOME_REPRESSION_OF_WNT_TARGET_GENES

```{r challenge12_2, exercise=TRUE}
barcodeplot(____, main="L.PregVsLac: REACTOME_REPRESSION_OF_WNT_TARGET_GENES")
```

```{r challenge12_2-solution, exercise.reveal_solution = FALSE}
barcodeplot(fit.cont$coeff[,2], index=c2.ind[["REACTOME_REPRESSION_OF_WNT_TARGET_GENES"]], main="L.PregVsLac: REACTOME_REPRESSION_OF_WNT_TARGET_GENES")
```

```{r challenge12_2-code-check}
grade_this_code()
```

3. You can put two gene sets on one plot, for example a set that is up-regulated and one that is down-regulated,
by adding a gene set to the `index2` argument. Produce a barcodeplot with the two sets REACTOME_REPRESSION_OF_WNT_TARGET_GENES and PID_WNT_CANONICAL_PATHWAY.

```{r challenge12_3, exercise=TRUE}
barcodeplot(____, main="L.PregVsLac: REACTOME_REPRESSION_OF_WNT_TARGET_GENES and PID_WNT_CANONICAL_PATHWAY sets")
````

```{r challenge12_3-solution, exercise.reveal_solution = FALSE}
barcodeplot(fit.cont$coeff[,2], index=c2.ind[["REACTOME_REPRESSION_OF_WNT_TARGET_GENES"]], index2=c2.ind[["PID_WNT_CANONICAL_PATHWAY"]], main="L.PregVsLac: REACTOME_REPRESSION_OF_WNT_TARGET_GENES and PID_WNT_CANONICAL_PATHWAY sets")
```

```{r challenge12_3-code-check}
grade_this_code()
```
---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup2, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
library(RColorBrewer)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 2**

1. Redo the plots with the colours for status (lactate, pregnant, virgin): `brewer.pal(3,"Dark2")`
2. Change the plotting characters to symbols, such that basal samples have the value `1` and luminal samples have the value `4`. HINT: use `pch` argument.
3. Add a legend for status at the top left and for cell type at the bottom.

```{r challenge2, exercise=TRUE}
# Get some nicer colours from brewer pal, using the "Dark2" palette.
cols <- brewer.pal(3,"Dark2")
col.status <- ____
char.celltype <- ____
plotMDS(y, col=____, pch=___, cex=2)
legend("topleft",____)
legend("bottom", ____)
```

```{r, challenge2-solution, exercise.reveal_solution = FALSE}
cols <- brewer.pal(3,"Dark2")
char.celltype <- c(1,4)[sampleinfo$CellType]
col.status <- cols[factor(sampleinfo$Status)]
plotMDS(y,col=col.status,pch=char.celltype,cex=2)
legend("topleft",legend=levels(sampleinfo$Status),col=cols,pch=16)
legend("bottom",legend=levels(sampleinfo$CellType),pch=c(1,4))
```


```{r challenge2-code-check}
grade_this_code()
```
---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup3, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(gplots)
library(RColorBrewer)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 3**

1. Change the colour scheme to "PiYG" and redo the heatmap. Try `?RColorBrewer` and see what other colour schemes are available.
2. Change the sample names to `group` using the `labCol` argument

```{r challenge3_1, exercise=TRUE}
mypalette <- brewer.pal(11, ____)
morecols <- colorRampPalette(____)   
heatmap.2(____,col=rev(____(50)),trace="none", main="Top 500 most variable genes across samples",ColSideColors=col.cell,labCol=____,scale="row",margins = c(8,5))
```

```{r challenge3_1-solution, exercise.reveal_solution = FALSE}
# Solution 1 and 2
mypalette <- brewer.pal(11,"PiYG")
morecols <- colorRampPalette(mypalette)
heatmap.2(highly_variable_lcpm,col=rev(morecols(50)),trace="none", main="Top 500 most variable genes across samples",ColSideColors=col.cell,labCol=group,scale="row",margins = c(8,5))
```

```{r challenge3_1-code-check}
grade_this_code()
```


3. Redo the heatmap using the top 500 LEAST variable genes.


```{r challenge3_3, exercise = TRUE}
# Select 500 least var genes
select_var <- ____
# Subset logcounts matrix
least_variable_lcpm <- ____
heatmap.2(____,col=rev(morecols(50)),trace="none", main="Top 500 least variable genes across samples",ColSideColors=col.cell,labCol=____,scale="row",margins=c(8,5))
```

```{r challenge3_3-solution, exercise.reveal_solution = FALSE}
# Select 500 least var genes
select_var <- names(sort(var_genes, decreasing=FALSE))[1:500]
head(select_var)
# Subset logcounts matrix
least_variable_lcpm <- logcounts[select_var,]
heatmap.2(least_variable_lcpm,col=rev(morecols(50)),trace="none", main="Top 500 least variable genes across samples",ColSideColors=col.cell,labCol=group,scale="row",margins=c(8,5))
```

```{r challenge3_3-code-check}
grade_this_code()
```

---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup4, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 4**

Plot the biased and unbiased MD plots side by side for the same sample to see the before and after TMM normalisation effect.

```{r challenge4, exercise=TRUE}
par(____)
plotMD(____)
abline(____)
plotMD(____)
abline(____)
```

```{r challenge4-solution, exercise.reveal_solution = FALSE}
par(mfrow=c(1,2))
plotMD(logcounts,column = 11)
abline(h=0,col="grey")
plotMD(y,column = 11)
abline(h=0,col="grey")
```

```{r challenge4-code-check}
grade_this_code()
```---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup5, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 5**

1. Add another contrast to the contrasts matrix: `L.PregVsLac = luminal.pregnant - luminal.lactate` and re-run the code above. You should have two comparisons in `fit.cont` now.
2. Check out the `vennDiagram` function
(HINT: type `?vennDiagram`).
Can you show the overlap of differentially expressed genes between the two comparisons? How many genes are commonly differentially expressed?

```{r challenge5, exercise=TRUE}
cont.matrix <- makeContrasts(B.PregVsLac=____,
                             L.PregVsLac=____,
                             levels=____)
fit.cont <- ____
fit.cont <- ____
summa.fit <- ____
summary(____)
# Venn diagram
par(mfrow=c(1,1))
vennDiagram(____,include=____,counts.col=c("purple", "black"),
    circle.col = c("blue", "green3"))
```

```{r challenge5-solution, exercise.reveal_solution = FALSE}
cont.matrix <- makeContrasts(B.PregVsLac=basal.pregnant - basal.lactate,
                             L.PregVsLac=luminal.pregnant - luminal.lactate,
                             levels=design)
fit.cont <- contrasts.fit(fit, cont.matrix)
fit.cont <- eBayes(fit.cont)
summa.fit <- decideTests(fit.cont)
summary(summa.fit)
# Venn diagram
par(mfrow=c(1,1))
vennDiagram(summa.fit,include=c("up", "down"),counts.col=c("purple", "black"),
    circle.col = c("blue", "green3"))
```

```{r challenge5-code-check}
grade_this_code()
```---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup6, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 6**

1. Generate the MD plot and volcano plot for the second comparison, `L.PregVsLac`. 
2. Change the number of highlighted genes to 200 in the volcano plot.
</div>

```{r challenge6, exercise=TRUE}
par(____)
plotMD(____)
volcanoplot(____)
```

```{r challenge6-solution, exercise.reveal_solution = FALSE}
par(mfrow=c(1,2))
plotMD(fit.cont,coef=2,status=summa.fit[,"L.PregVsLac"], values=c(-1, 1), hl.col=c("blue","red"))
volcanoplot(fit.cont,coef=2,highlight=200,names=fit.cont$genes$SYMBOL)
```

```{r challenge6-code-check}
grade_this_code()
```---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup7, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 7**

1. Generate the MD plot and volcano plot for the second comparison, `L.PregVsLac`. 
2. Change the number of highlighted genes to 200 in the volcano plot.

```{r challenge7, exercise=TRUE}
topTable(____)
stripchart(____)
```

```{r challenge7-solution, exercise.reveal_solution = FALSE}
topTable(fit.cont,coef=2,sort.by="p")
stripchart(v$E["12992",]~group,vertical=TRUE,las=2,cex.axis=0.8,pch=16,cex=1.3,col=nice.col,method="jitter",ylab="Normalised log2 expression",main="Csn1s2b", cex.axis=0.6)
```

```{r challenge7-code-check}
grade_this_code()
```---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup8, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 8**

Change the cut-off so that we are interested in genes that change at least 50\% on the fold change scale.

HINT: what is the corresponding logFC value of 50\% fold change? Assume basal.pregnant is 50\% higher than basal.lactate.

```{r challenge8, exercise=TRUE}
cutoff <- log2(____)
fit.treat <- treat(____)
res.treat <- decideTests(___)
summary(____)
topTable(____)
```

```{r challenge8-solution, exercise.reveal_solution = FALSE}
cutoff <- log2(1.5)
fit.treat <- treat(fit.cont,lfc=cutoff)
res.treat <- decideTests(fit.treat)
summary(res.treat)
topTable(fit.treat,coef=1,sort.by="p")
```

```{r challenge8-code-check}
grade_this_code()
```---
output: 
  html_document
runtime: shiny_prerendered
---

```{r setup9, include=FALSE}
library(learnr)
library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(limma)
```

```{r}
if(!exists("sampleinfo")) {
    load("../data/data.Rdata")
}
```

**Challenge 9**

Perform GO analysis for the second comparison, "L.PregVsLac", taking into account gene length information.

```{r challenge9, exercise=TRUE}
go_LPregvsLac <- goana(____)
topGO(____)
```

```{r challenge9-solution, exercise.reveal_solution = FALSE}
go_LPregvsLac <- goana(fit.cont,coef="L.PregVsLac",species="Mm",
                       covariate=gene_length)
topGO(go_LPregvsLac, n=10)
```

```{r challenge9-code-check}
grade_this_code()
```
